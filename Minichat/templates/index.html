<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>MiniChat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="app">
    <div class="sidebar">
        <h3>ðŸ‘¤ {{ username }}</h3>
        <h4>UÅ¼ytkownicy</h4>
        <ul id="users">
            {% for u in users %}
                <li onclick="selectUser({{ u.id }}, '{{ u.username }}')" class="{{ 'online' if u.online else 'offline' }}">
                    {{ u.username }}
                </li>
            {% endfor %}
        </ul>
        <a href="{{ url_for('logout') }}" class="logout">Wyloguj</a>
    </div>

    <div class="chat">
        <div id="chat-header">Wybierz rozmÃ³wcÄ™</div>
        <div id="messages"></div>
        <div class="input-area">
            <input id="msg" placeholder="Napisz wiadomoÅ›Ä‡...">
            <button onclick="send()">WyÅ›lij</button>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
let currentId = null;
let currentRoom = null;
let socket = io();

function selectUser(id, name) {
    currentId = id;
    currentRoom = `room_${Math.min({{ my_id }}, id)}_${Math.max({{ my_id }}, id)}`;
    document.getElementById('chat-header').textContent = 'Czat z: ' + name;
    socket.emit('join_chat', {receiver_id: id});
}

socket.on('load_messages', function(msgs){
    const box = document.getElementById('messages');
    box.innerHTML = '';
    msgs.forEach(m => {
        const div = document.createElement('div');
        div.textContent = `${m.sender}: ${m.body}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

socket.on('receive_message', function(msg){
    if(msg.room !== currentRoom) return;
    const box = document.getElementById('messages');
    const div = document.createElement('div');
    div.textContent = `${msg.sender}: ${msg.body}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
});

function send() {
    const msg = document.getElementById('msg').value;
    if(!currentId || !msg) return;
    socket.emit('send_message', {receiver_id: currentId, body: msg});
    document.getElementById('msg').value = '';
}
</script>
</body>
</html>
